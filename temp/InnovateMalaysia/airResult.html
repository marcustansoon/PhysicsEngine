<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<head>
<title>End User Air Result</title>
<style> table, td, th { border: 1px solid black;text-align: center; } table { border-collapse: collapse; width: 100%; } th { padding-top: 6px; padding-bottom: 6px; text-align: left; background-color: #4CAF50; color: white; text-align: center; } tr:nth-child(even){background-color: #f2f2f2;}
.button1 { 
box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); 
background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 5px 16px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 12px;
  margin: 1px 2px;
  cursor: pointer;
  -webkit-transition-duration: 0.4s; /* Safari */
  transition-duration: 0.4s;
}
</style>
</head>


<table id="table">
  <tr>
  <th>No</th>
  <th>Device IDs</th>
  <th>Date Modified</th>
  <th></th>
  </tr>
  <tr>
  <td>1</td>
  <td>de</td>
  <td>asd</td>
  <td><button onclick="openGraph();">>></button></td>
  </tr>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<canvas id="temperatureChart"></canvas>
 
<body style="padding:3%;">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>
 	console.log(location.href);
 
 
	let socket = io("https://drone-end-user.glitch.me/"),//connect to server
    partitionKey="partitionKey"//location.href.replace("https://www.w3schools.com/html/tryit.asp?filename=tryhtml_intro?partitionKey=","");//get partitionkey by url
    
    function setEndUserPhone(){
      socket.emit("setEndUserPhone");
    }
    socket.on("sensorData",function(data){
      	//xlabels.push(data.NH3);
   		//ylabels.push(data.date);
        //chart.update();
    });
 
 
let ctx_temperatureChart = document.getElementById('temperatureChart').getContext('2d'),
xlabels_temperature=[],
ylabels=[],
table = document.getElementById('table'),graphData,isBinded=false,iframe ;

let temperatureChart = new Chart(ctx_temperatureChart, {
    // The type of chart we want to create
    type: 'line',
    // The data for our dataset
    data: {
        labels:ylabels,
        datasets: [{
            label: 'Temperature (*C)',
            backgroundColor: 'rgba(255, 255, 255,0)',
            borderColor: 'rgba(26,206,197,1)',
            data: xlabels_temperature
             
        }]
    }, 
    // Configuration options go here
    options: {}
});

	socket.on("connect",function(){
 		socket.emit("getRecords",{partitionKey:partitionKey,measurementType:"air"});
    });
   	socket.on("getRecords",function(data){
    	console.log(JSON.stringify(data));
        string="";
        string="<tr> <th>No</th> <th>Date Modified</th> <th>Device IDs</th><th></th> </tr>";
        for (let loop=0;loop<data.length;loop++){
        	let temp=loop+1;
            string+="<tr><td>"+temp+"</td>";
            string+="<td>"+data[loop].deviceID+"</td>";
            let d=new Date(data[loop].date);//create Date obj from the old records
            string+="<td>"+d.getDate()+"/"+d.getMonth()+"/"+d.getFullYear()+" "+addZero(d.getHours())+":"+addZero(d.getMinutes())+"</td><td>";
            string+="<button class='button1' onclick='openGraph("+JSON.stringify(data[loop].data)+");'>>></button></td></tr>";
            table.innerHTML=string;
        }

   });
   
   function addZero(i) { if (i < 10) { i = "0" + i; } return i; }
   function openGraph(data){
      console.log(data);
      graphData=data;
      xlabels_temperature.length=0;
      ylabels.length=0;
      for (let loop=0;loop<data.length;loop++){
          xlabels_temperature.push(data[loop].temperature);
         // xlabels_turbidity.push(data[loop].turbidity);
          ylabels.push(data[loop].date);
      }
      temperatureChart.update();
      //ECChart.update();
   
   
   if (iframe){
   	iframe.src = "https://jsfiddle.net/wb08v1dt/42/show";
    return;
   }else{
   iframe = document.createElement("iframe");
  iframe.width = "95%";
  //iframe.style="position:relative;left:50%;transform:translate(-50%);"
  iframe.height = "350";
  iframe.allow = "geolocation";
  iframe.src = "https://jsfiddle.net/wb08v1dt/42/show";
  iframe.id="iframe";
  document.body.append(iframe);
	}
    iframe.onload=function(){
     let loadTime=Date.now();
     socket.emit("mapBindings",{loadTime:loadTime});//send load Time to server for map-end user binding purposes
     
     setTimeout(function(){
     	if(!isBinded)location.reload(true);
     },2000);
	}
    
   }

	socket.on("mapBindings",function(data){//when binding is successful
    //data-{socketID}
    	console.log(data);isBinded=true;
        socket.emit("emitTo",{socketID:data.socketID,title:"graphData",data:{ lat:1.5304313999999999, lng:110.3606818, data:graphData}});
//{socketID:data.socketID,title:"graphData",data:{ lat:1.5304313999999999, lng:110.3606818, data: [{NH3:15,CO:1,NO2:2,CH4:3,lat:1.5304413999999999,lng:110.3603818},{NH3:15,CO:1,NO2:2,CH4:2,lat:1.5307613999999999,lng:110.3623618}] }}
    });


</script>

</body>
</html>
